events {}

http {
  # Map origin for CORS
  map $http_origin $cors_header {
    default "*";
  }

  # ======================
  # Dashboard API (5005)
  # ======================
  server {
    listen 8081;

    location / {
      proxy_pass http://172.17.0.1:5005;
      proxy_set_header Host $host;
      add_header Access-Control-Allow-Origin $cors_header always;
      add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
      add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;

      # Preflight
      if ($request_method = OPTIONS) {
        add_header Access-Control-Allow-Origin $cors_header always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
        add_header Content-Length 0;
        add_header Content-Type text/plain;
        return 204;
      }
    }
  }

  # ======================
  # Viewer (8000)
  # ======================
  server {
    listen 8082;

    location / {
      proxy_pass http://172.17.0.1:8000;
      proxy_set_header Host $host;
      add_header Access-Control-Allow-Origin $cors_header always;
      add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
      add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
    }
  }

  # ======================
  # Database UI (8085)
  # ======================
  server {
    listen 8083;

    location / {
      proxy_pass http://172.17.0.1:8085;
      proxy_set_header Host $host;
      add_header Access-Control-Allow-Origin $cors_header always;
      add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
      add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
    }
  }
}

