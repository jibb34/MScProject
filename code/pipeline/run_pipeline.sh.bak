#!/bin/bash

# ------------------------------------------------------------------
# 0. Configuration constants
# ------------------------------------------------------------------

VENV_DIR=".venv"
REQ_FILE="requirements.txt"
MAIN_SCRIPT="prepare_map.py"
CONFIG_FILE="settings.yml"
PROFILE_PATH="osrm/profile.lua"
OSRM_DATA_DIR="osrm/data"
DEBUG=0

# ------------------------------------------------------------------
# 1. YAML parsing function
# ------------------------------------------------------------------

function parse_yaml_value() {
  grep "^$1" "$CONFIG_FILE" | sed "s/^$1:[ ]*//" | tr -d '"'
}

if [ ! -f "$CONFIG_FILE" ]; then
  echo "[ERROR] $CONFIG_FILE not found!"
  exit 1
fi

# ------------------------------------------------------------------
# 1.1. Load all settings into variables
# ------------------------------------------------------------------

GPX_FILE=$(parse_yaml_value "gpx_file")
OSM_OUTPUT=$(parse_yaml_value "osm_output")
CHUNK_SIZE=$(parse_yaml_value "chunk_size")
JSON_DIR=$(parse_yaml_value "json_directory")
RADIUS=$(parse_yaml_value "radius")
DYNAMIC_WINDOW=$(parse_yaml_value "dynamic_radius_window")
# ... load other keys similarly ...
OSRM_BASENAME=$(basename "$OSM_OUTPUT" .osm)

# Error if no .gpx or output directory found
if [ -z "$GPX_FILE" ] || [ -z "$OSM_OUTPUT" ]; then
  "[ERROR] gpx_file and osm_output must be set in $CONFIG_FILE"
  exit 1
fi

if [ -z "$CHUNK_SIZE" ]; then
  CHUNK_SIZE=0
fi

if [ "$CHUNK_SIZE" -gt 200 ]; then
  echo "[ERROR] Chunk Size cannot go beyond 50 points, due to current GET limits"
  exit 1
fi

echo "Starting pipeline..."
echo "[INIT] GPX file: $GPX_FILE"
echo "[INIT] OSM output file: $OSM_OUTPUT"

# ------------------------------------------------------------------
# 2. Create & activate Python virtualenv
# ------------------------------------------------------------------

if [ ! -d "$VENV_DIR" ]; then
  echo "[INIT] Creating virtual environment..."
  python3 -m venv "$VENV_DIR"
fi

source "$VENV_DIR/bin/activate"

#Create hash for caching
CURRENT_HASH=$(sha256sum "${REQ_FILE}" | awk '{print $1}')

# If saved hash differs, reinstall & update hash
#
if [[ ! -f "${REQ_HASH_FILE}" ]] || [[ "$(cat "${REQ_HASH_FILE}")" != "${CURRENT_HASH}" ]]; then
  echo "[INFO] requirements.txt changed (or first run). Installing dependencies…"
  pip install --upgrade pip
  pip install -r "${REQ_FILE}"
  echo "${CURRENT_HASH}" >"${REQ_HASH_FILE}"
else
  echo "[INFO] requirements.txt unchanged. Skipping pip install"
fi

echo "[INIT] Installing Python dependencies (if needed)..."
pip install --upgrade pip
pip install --quiet -r "$REQ_FILE"

# ------------------------------------------------------------------
# 3. Prepare map & split GPX
# ------------------------------------------------------------------

echo "[PYTHON] Running ${MAIN_SCRIPT}"
python3 "$MAIN_SCRIPT" \
  "$GPX_FILE" \
  "$OSM_OUTPUT" \
  "$JSON_DIR" \
  "$RADIUS" \
  "$CHUNK_SIZE"
echo "[PYTHON] Map Downloaded as .osm"

# ------------------------------------------------------------------
# 4. Copy OSM into OSRM dir
# ------------------------------------------------------------------

echo "[SHELL] Copying files to Docker Volumes"
mkdir -p "$OSRM_DATA_DIR"
cp "$OSM_OUTPUT" "$OSRM_DATA_DIR/$OSRM_BASENAME.osm"

# ------------------------------------------------------------------
# 5. Convert .osm → .pbf via docker osmium
# ------------------------------------------------------------------

#Build Docker image
echo "[DOCKER] Starting Osmium Docker container"
docker build -t osmium-converter ./osmium

echo "[DOCKER] Performing conversion of OSM XML to PBF with Osmium"
docker run --rm \
  -v "$PWD/$OSRM_DATA_DIR:/data" \
  osmium-converter \
  cat "/data/$OSRM_BASENAME.osm" -o "/data/$OSRM_BASENAME.osm.pbf" -f pbf --overwrite >>/dev/null 2>&1

# Return file info for user feedback
docker run --rm \
  -v "$PWD/$OSRM_DATA_DIR:/data" \
  osmium-converter \
  fileinfo "/data/$OSRM_BASENAME.osm.pbf"

if [ ! -f "$OSRM_DATA_DIR/$OSRM_BASENAME.osm.pbf" ]; then
  echo "[FATAL] Osmium conversion failed or output is missing"
  exit 1
fi

# ------------------------------------------------------------------
# 6. Prepare OSRM graph via docker osrm-backend
# ------------------------------------------------------------------

echo "[DOCKER] Pre-processing $OSM_OUTPUT with custom profile: $PROFILE_PATH"
docker run --rm \
  -v "$PWD/$OSRM_DATA_DIR:/data" \
  -v "$PWD/$PROFILE_PATH:/opt/profile.lua" \
  osrm/osrm-backend \
  bash -c "\
  osrm-extract -p /opt/profile.lua '/data/$OSRM_BASENAME.osm' &&
  osrm-partition '/data/$OSRM_BASENAME.osrm' &&
  osrm-customize '/data/$OSRM_BASENAME.osrm' " >>/dev/null 2>&1

# ------------------------------------------------------------------
# 7. Start detached OSRM routing server
# ------------------------------------------------------------------

echo "[DOCKER] Launching OSRM Container"
docker run -d \
  -v "$PWD/$OSRM_DATA_DIR:/data" \
  -p 5000:5000 \
  --name osrm \
  osrm/osrm-backend \
  osrm-routed --algorithm mld --max-matching-size 500 "/data/$OSRM_BASENAME.osrm" >>/dev/null 2>&1

# ------------------------------------------------------------------
# 8. Batch matching of GPX chunks
# ------------------------------------------------------------------

python3 batch_route_calc.py "./data/temp" $DYNAMIC_WINDOW

# ------------------------------------------------------------------
# 9. Visualize results
# ------------------------------------------------------------------

python3 plot_map.py #OPTIONAL: Add other methods of visualisation...
# this area is just for testing purposes.

# ------------------------------------------------------------------
# 10. Cleanup
# ------------------------------------------------------------------

echo "[CLEANUP] Cleaning up JSON chunks..."
rm -rf data/temp/*
rm -rf data/results/*
echo "[CLEANUP] Removing excess map data..."
rm -rf osrm/data/*

echo "[CLEANUP] Cleaning up virtual environment..."
deactivate
echo "[CLEANUP] Shutting down Docker container"
docker rm -f osrm >/dev/null 2>&1 || true
# rm -rf "$VENV_DIR"

echo "Done :)"
